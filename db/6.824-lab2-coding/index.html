<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>6.824 Lab2 Coding | 斯是陋室</title><meta name=keywords content><meta name=description content="flow
livelocks 系统没有阻塞。但是状态来回转换，没有进展。比如多节点同时竞选。
当收到心跳、自己参与竞选、收到竞选申请时，三种情况下，都要重置election timeout 计时
Incorrect RPC handler 如果reply false，快速结束，不要执行其余子过程 entries为null的rpc也要处理 日志处理的rule5是必要的 Failure to follow rule 确保apply只进行了一次 周期检查commit和apply或者每次commit时apply 如果append 由于term不一致被拒绝，不要更新nextIndex 不能更新以前term的commit Term confusion 当获得来自以前term的reply。如果term不同，不处理 2A：leader election 官方hints
RequestVote 参加竞选 handler 参与投票。5秒内选出新leader AppendEntries 心跳。 每秒不超过十次 犯的几个错：
忘了维护votedFor的值 心跳的间隔时间要确保小于随机check时间 旧主以及竞选失败者 收到心跳时，没有退化 旧主disconnects，进入election，但是没有竞选 leader 也给自己发了心跳 收到竞选，停止心跳检查，停止参加竞选 计票统计，没有并发控制 参与竞选，要并发执行 几个实现：
log 标准化，每次打印当前 raft的状态的，并用emoji来区分 log.SetFlags(log.Lmicroseconds) 可变参数的引用和解引用 func (rf Raft) Log(format string, args ...interface{}) { RaftPrintf(format, args...) } 2B：log 官方hints
实现 election restriction 可能会出现多主的bug，请查看timer的实现或者不要立刻发心跳 通过condition 或者 sleep，不要让检查状态的进程死循环 犯的错"><meta name=author content="homily"><link rel=canonical href=https://homily707.github.io/db/6.824-lab2-coding/><link crossorigin=anonymous href=/assets/css/stylesheet.d7fb4cbf980fe688a21621b06a795933c4e6bb2d4070ec940667af1715d84af2.css integrity="sha256-1/tMv5gP5oiiFiGwanlZM8Tmuy1AcOyUBmevFxXYSvI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://homily707.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://homily707.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://homily707.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://homily707.github.io/apple-touch-icon.png><link rel=mask-icon href=https://homily707.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="6.824 Lab2 Coding"><meta property="og:description" content="flow
livelocks 系统没有阻塞。但是状态来回转换，没有进展。比如多节点同时竞选。
当收到心跳、自己参与竞选、收到竞选申请时，三种情况下，都要重置election timeout 计时
Incorrect RPC handler 如果reply false，快速结束，不要执行其余子过程 entries为null的rpc也要处理 日志处理的rule5是必要的 Failure to follow rule 确保apply只进行了一次 周期检查commit和apply或者每次commit时apply 如果append 由于term不一致被拒绝，不要更新nextIndex 不能更新以前term的commit Term confusion 当获得来自以前term的reply。如果term不同，不处理 2A：leader election 官方hints
RequestVote 参加竞选 handler 参与投票。5秒内选出新leader AppendEntries 心跳。 每秒不超过十次 犯的几个错：
忘了维护votedFor的值 心跳的间隔时间要确保小于随机check时间 旧主以及竞选失败者 收到心跳时，没有退化 旧主disconnects，进入election，但是没有竞选 leader 也给自己发了心跳 收到竞选，停止心跳检查，停止参加竞选 计票统计，没有并发控制 参与竞选，要并发执行 几个实现：
log 标准化，每次打印当前 raft的状态的，并用emoji来区分 log.SetFlags(log.Lmicroseconds) 可变参数的引用和解引用 func (rf Raft) Log(format string, args ...interface{}) { RaftPrintf(format, args...) } 2B：log 官方hints
实现 election restriction 可能会出现多主的bug，请查看timer的实现或者不要立刻发心跳 通过condition 或者 sleep，不要让检查状态的进程死循环 犯的错"><meta property="og:type" content="article"><meta property="og:url" content="https://homily707.github.io/db/6.824-lab2-coding/"><meta property="og:image" content="https://homily707.github.io/%3Cimage%20path/url%3E"><meta property="article:section" content="db"><meta property="article:published_time" content="2022-05-02T13:09:12+08:00"><meta property="article:modified_time" content="2022-05-02T13:09:12+08:00"><meta property="og:site_name" content="mysite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://homily707.github.io/%3Cimage%20path/url%3E"><meta name=twitter:title content="6.824 Lab2 Coding"><meta name=twitter:description content="flow
livelocks 系统没有阻塞。但是状态来回转换，没有进展。比如多节点同时竞选。
当收到心跳、自己参与竞选、收到竞选申请时，三种情况下，都要重置election timeout 计时
Incorrect RPC handler 如果reply false，快速结束，不要执行其余子过程 entries为null的rpc也要处理 日志处理的rule5是必要的 Failure to follow rule 确保apply只进行了一次 周期检查commit和apply或者每次commit时apply 如果append 由于term不一致被拒绝，不要更新nextIndex 不能更新以前term的commit Term confusion 当获得来自以前term的reply。如果term不同，不处理 2A：leader election 官方hints
RequestVote 参加竞选 handler 参与投票。5秒内选出新leader AppendEntries 心跳。 每秒不超过十次 犯的几个错：
忘了维护votedFor的值 心跳的间隔时间要确保小于随机check时间 旧主以及竞选失败者 收到心跳时，没有退化 旧主disconnects，进入election，但是没有竞选 leader 也给自己发了心跳 收到竞选，停止心跳检查，停止参加竞选 计票统计，没有并发控制 参与竞选，要并发执行 几个实现：
log 标准化，每次打印当前 raft的状态的，并用emoji来区分 log.SetFlags(log.Lmicroseconds) 可变参数的引用和解引用 func (rf Raft) Log(format string, args ...interface{}) { RaftPrintf(format, args...) } 2B：log 官方hints
实现 election restriction 可能会出现多主的bug，请查看timer的实现或者不要立刻发心跳 通过condition 或者 sleep，不要让检查状态的进程死循环 犯的错"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Dbs","item":"https://homily707.github.io/db/"},{"@type":"ListItem","position":2,"name":"6.824 Lab2 Coding","item":"https://homily707.github.io/db/6.824-lab2-coding/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"6.824 Lab2 Coding","name":"6.824 Lab2 Coding","description":"flow\nlivelocks 系统没有阻塞。但是状态来回转换，没有进展。比如多节点同时竞选。\n当收到心跳、自己参与竞选、收到竞选申请时，三种情况下，都要重置election timeout 计时\nIncorrect RPC handler 如果reply false，快速结束，不要执行其余子过程 entries为null的rpc也要处理 日志处理的rule5是必要的 Failure to follow rule 确保apply只进行了一次 周期检查commit和apply或者每次commit时apply 如果append 由于term不一致被拒绝，不要更新nextIndex 不能更新以前term的commit Term confusion 当获得来自以前term的reply。如果term不同，不处理 2A：leader election 官方hints\nRequestVote 参加竞选 handler 参与投票。5秒内选出新leader AppendEntries 心跳。 每秒不超过十次 犯的几个错：\n忘了维护votedFor的值 心跳的间隔时间要确保小于随机check时间 旧主以及竞选失败者 收到心跳时，没有退化 旧主disconnects，进入election，但是没有竞选 leader 也给自己发了心跳 收到竞选，停止心跳检查，停止参加竞选 计票统计，没有并发控制 参与竞选，要并发执行 几个实现：\nlog 标准化，每次打印当前 raft的状态的，并用emoji来区分 log.SetFlags(log.Lmicroseconds) 可变参数的引用和解引用 func (rf Raft) Log(format string, args ...interface{}) { RaftPrintf(format, args...) } 2B：log 官方hints\n实现 election restriction 可能会出现多主的bug，请查看timer的实现或者不要立刻发心跳 通过condition 或者 sleep，不要让检查状态的进程死循环 犯的错","keywords":[],"articleBody":"flow\nlivelocks 系统没有阻塞。但是状态来回转换，没有进展。比如多节点同时竞选。\n当收到心跳、自己参与竞选、收到竞选申请时，三种情况下，都要重置election timeout 计时\nIncorrect RPC handler 如果reply false，快速结束，不要执行其余子过程 entries为null的rpc也要处理 日志处理的rule5是必要的 Failure to follow rule 确保apply只进行了一次 周期检查commit和apply或者每次commit时apply 如果append 由于term不一致被拒绝，不要更新nextIndex 不能更新以前term的commit Term confusion 当获得来自以前term的reply。如果term不同，不处理 2A：leader election 官方hints\nRequestVote 参加竞选 handler 参与投票。5秒内选出新leader AppendEntries 心跳。 每秒不超过十次 犯的几个错：\n忘了维护votedFor的值 心跳的间隔时间要确保小于随机check时间 旧主以及竞选失败者 收到心跳时，没有退化 旧主disconnects，进入election，但是没有竞选 leader 也给自己发了心跳 收到竞选，停止心跳检查，停止参加竞选 计票统计，没有并发控制 参与竞选，要并发执行 几个实现：\nlog 标准化，每次打印当前 raft的状态的，并用emoji来区分 log.SetFlags(log.Lmicroseconds) 可变参数的引用和解引用 func (rf Raft) Log(format string, args ...interface{}) { RaftPrintf(format, args...) } 2B：log 官方hints\n实现 election restriction 可能会出现多主的bug，请查看timer的实现或者不要立刻发心跳 通过condition 或者 sleep，不要让检查状态的进程死循环 犯的错\n锁重入会导致阻塞 chan一定要初始化 commit以后没有通知 有一个地方term 写成了index ","wordCount":"78","inLanguage":"en","image":"https://homily707.github.io/%3Cimage%20path/url%3E","datePublished":"2022-05-02T13:09:12+08:00","dateModified":"2022-05-02T13:09:12+08:00","author":{"@type":"Person","name":"homily"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://homily707.github.io/db/6.824-lab2-coding/"},"publisher":{"@type":"Organization","name":"斯是陋室","logo":{"@type":"ImageObject","url":"https://homily707.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://homily707.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://homily707.github.io/algo/ title=算法><span>算法</span></a></li><li><a href=https://homily707.github.io/db/ title=数据库><span>数据库</span></a></li><li><a href=https://homily707.github.io/k8s/ title=k8s><span>k8s</span></a></li><li><a href=https://homily707.github.io/go/ title=go><span>go</span></a></li><li><a href=https://homily707.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://homily707.github.io/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://homily707.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://homily707.github.io/db/>Dbs</a></div><h1 class=post-title>6.824 Lab2 Coding</h1><div class=post-meta><span title='2022-05-02 13:09:12 +0800 CST'>May 2, 2022</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;78 words&nbsp;·&nbsp;homily&nbsp;|&nbsp;<a href=https://github.com/homily707/homily707.github.io/issues rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#livelocks>livelocks</a></li><li><a href=#incorrect-rpc-handler>Incorrect RPC handler</a></li><li><a href=#failure-to-follow-rule>Failure to follow rule</a></li><li><a href=#term-confusion>Term confusion</a></li></ul></li><li><a href=#2aleader-election>2A：leader election</a></li><li><a href=#2blog>2B：log</a></li></ul></nav></div></details></div><div class=post-content><p><a href="https://secure2.wostatic.cn/static/vPBXeHAMpie6U6A5LvYEef/election.png?auth_key=1656738423-wjXusocft1qipuWjJeHVHQ-0-509ffb24ae06dbf415e963faaa40dd2f">flow</a></p><h3 id=livelocks>livelocks<a hidden class=anchor aria-hidden=true href=#livelocks>#</a></h3><p>系统没有阻塞。但是状态来回转换，没有进展。比如多节点同时竞选。</p><p>当收到心跳、自己参与竞选、收到竞选申请时，三种情况下，都要重置election timeout 计时</p><h3 id=incorrect-rpc-handler>Incorrect RPC handler<a hidden class=anchor aria-hidden=true href=#incorrect-rpc-handler>#</a></h3><ul><li>如果reply false，快速结束，不要执行其余子过程</li><li>entries为null的rpc也要处理</li><li>日志处理的rule5是必要的</li></ul><h3 id=failure-to-follow-rule>Failure to follow rule<a hidden class=anchor aria-hidden=true href=#failure-to-follow-rule>#</a></h3><ul><li>确保apply只进行了一次</li><li>周期检查commit和apply或者每次commit时apply</li><li>如果append 由于term不一致被拒绝，不要更新nextIndex</li><li>不能更新以前term的commit</li></ul><h3 id=term-confusion>Term confusion<a hidden class=anchor aria-hidden=true href=#term-confusion>#</a></h3><ul><li>当获得来自以前term的reply。如果term不同，不处理</li><li></li></ul><h2 id=2aleader-election>2A：leader election<a hidden class=anchor aria-hidden=true href=#2aleader-election>#</a></h2><p>官方hints</p><ul><li>RequestVote 参加竞选 handler 参与投票。<strong>5秒内选出新leader</strong></li><li>AppendEntries 心跳。 <strong>每秒不超过十次</strong></li></ul><p>犯的几个错：</p><ul><li>忘了维护votedFor的值</li><li>心跳的间隔时间要确保小于随机check时间</li><li>旧主以及竞选失败者 收到心跳时，没有退化</li><li>旧主disconnects，进入election，但是没有竞选</li><li>leader 也给自己发了心跳</li><li>收到竞选，停止心跳检查，停止参加竞选</li><li>计票统计，没有并发控制</li><li>参与竞选，要并发执行</li></ul><p>几个实现：</p><ul><li>log 标准化，每次打印当前 raft的状态的，并用emoji来区分</li><li>log.SetFlags(log.Lmicroseconds)</li><li>可变参数的引用和解引用</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>func <span class=o>(</span>rf Raft<span class=o>)</span> Log<span class=o>(</span>format string, args ...interface<span class=o>{})</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  RaftPrintf<span class=o>(</span>format, args...<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=2blog>2B：log<a hidden class=anchor aria-hidden=true href=#2blog>#</a></h2><p>官方hints</p><ul><li>实现 election restriction</li><li>可能会出现多主的bug，请查看timer的实现或者不要立刻发心跳</li><li>通过condition 或者 sleep，不要让检查状态的进程死循环</li></ul><p>犯的错</p><ul><li>锁重入会导致阻塞</li><li>chan一定要初始化</li><li>commit以后没有通知</li><li>有一个地方term 写成了index</li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer><script src=https://utteranc.es/client.js repo=homily707/homily707.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://homily707.github.io/>斯是陋室</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>