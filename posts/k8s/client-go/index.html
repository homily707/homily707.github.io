<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Client Go | æ–¯æ˜¯é™‹å®¤</title><meta name=keywords content="go,k8s"><meta name=description content="work queue Queue
queue []t // å®šä¹‰å…ƒç´ çš„å¤„ç†é¡ºåºï¼Œé‡Œé¢æ‰€æœ‰å…ƒç´ éƒ½åº”è¯¥åœ¨ dirty set ä¸­æœ‰ï¼Œè€Œä¸èƒ½å‡ºç°åœ¨ processing set ä¸­ dirty set // æ ‡è®°æ‰€æœ‰éœ€è¦è¢«å¤„ç†çš„å…ƒç´  processing set // å½“å‰æ­£åœ¨è¢«å¤„ç†çš„å…ƒç´ ï¼Œå½“å¤„ç†å®Œåéœ€è¦æ£€æŸ¥è¯¥å…ƒç´ æ˜¯å¦åœ¨ dirty set ä¸­ï¼Œå¦‚æœæœ‰åˆ™æ·»åŠ åˆ° queue é‡Œ DelayingQueue å¤šäº†ä¸€ä¸ªAddAfterï¼Œæ¯æ¬¡addåŠ å…¥å †ä¸­ï¼Œæ¯æ¬¡æ‹¿å‡ºæœ€æ—©çš„
RateLimitingQueueã€‚é™é€Ÿé˜Ÿåˆ—
Delta FIFO æ¥å£queue
æ¥å£store
items map[string]Delta
Delta. äº”ç§type added updated deleted replaced sync . å¸¦ä¸€ä¸ª interface{}
Popæ–¹æ³•ï¼šä¼šé˜»å¡ã€‚ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥é‡æ–°å…¥é˜Ÿ
Indexer type Indexer interface { Store Index(indexName string, obj interface{}) ([]interface{}, error) // æ ¹æ®ç´¢å¼•åå’Œç»™å®šçš„å¯¹è±¡è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡ IndexKeys(indexName, indexedValue string) ([]string, error) // æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡çš„ key ListIndexFuncValues(indexName string) []string // åˆ—å‡ºç´¢å¼•å‡½æ•°è®¡ç®—å‡ºæ¥çš„æ‰€æœ‰ç´¢å¼•å€¼ ByIndex(indexName, indexedValue string) ([]interface{}, error) // æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡ GetIndexers() Indexers // è·å–æ‰€æœ‰çš„ Indexersï¼Œå¯¹åº” map[string]IndexFunc ç±»å‹ AddIndexers(newIndexers Indexers) error // è¿™ä¸ªæ–¹æ³•è¦åœ¨æ•°æ®åŠ å…¥å­˜å‚¨å‰è°ƒç”¨ï¼Œæ·»åŠ æ›´å¤šçš„ç´¢å¼•æ–¹æ³•ï¼Œé»˜è®¤åªé€šè¿‡ namespace æ£€ç´¢ } type Store interface { Add(obj interface{}) error Update(obj interface{}) error Delete(obj interface{}) error List() []interface{} ListKeys() []string Get(obj interface{}) (item interface{}, exists bool, err error) GetByKey(key string) (item interface{}, exists bool, err error) Replace([]interface{}, string) error Resync() error } // é»˜è®¤å®ç°ç±» type cache struct { cacheStorage ThreadSafeStore keyFunc KeyFunc } keyfunc è®¡ç®— objectçš„keyï¼Œç„¶åç”¨ThreadSafeStoreå­˜å‚¨keyï¼šobject"><meta name=author content="homily"><link rel=canonical href=https://homily707.github.io/posts/k8s/client-go/><link crossorigin=anonymous href=/assets/css/stylesheet.d7fb4cbf980fe688a21621b06a795933c4e6bb2d4070ec940667af1715d84af2.css integrity="sha256-1/tMv5gP5oiiFiGwanlZM8Tmuy1AcOyUBmevFxXYSvI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://homily707.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://homily707.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://homily707.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://homily707.github.io/apple-touch-icon.png><link rel=mask-icon href=https://homily707.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="Client Go"><meta property="og:description" content="work queue Queue
queue []t // å®šä¹‰å…ƒç´ çš„å¤„ç†é¡ºåºï¼Œé‡Œé¢æ‰€æœ‰å…ƒç´ éƒ½åº”è¯¥åœ¨ dirty set ä¸­æœ‰ï¼Œè€Œä¸èƒ½å‡ºç°åœ¨ processing set ä¸­ dirty set // æ ‡è®°æ‰€æœ‰éœ€è¦è¢«å¤„ç†çš„å…ƒç´  processing set // å½“å‰æ­£åœ¨è¢«å¤„ç†çš„å…ƒç´ ï¼Œå½“å¤„ç†å®Œåéœ€è¦æ£€æŸ¥è¯¥å…ƒç´ æ˜¯å¦åœ¨ dirty set ä¸­ï¼Œå¦‚æœæœ‰åˆ™æ·»åŠ åˆ° queue é‡Œ DelayingQueue å¤šäº†ä¸€ä¸ªAddAfterï¼Œæ¯æ¬¡addåŠ å…¥å †ä¸­ï¼Œæ¯æ¬¡æ‹¿å‡ºæœ€æ—©çš„
RateLimitingQueueã€‚é™é€Ÿé˜Ÿåˆ—
Delta FIFO æ¥å£queue
æ¥å£store
items map[string]Delta
Delta. äº”ç§type added updated deleted replaced sync . å¸¦ä¸€ä¸ª interface{}
Popæ–¹æ³•ï¼šä¼šé˜»å¡ã€‚ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥é‡æ–°å…¥é˜Ÿ
Indexer type Indexer interface { Store Index(indexName string, obj interface{}) ([]interface{}, error) // æ ¹æ®ç´¢å¼•åå’Œç»™å®šçš„å¯¹è±¡è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡ IndexKeys(indexName, indexedValue string) ([]string, error) // æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡çš„ key ListIndexFuncValues(indexName string) []string // åˆ—å‡ºç´¢å¼•å‡½æ•°è®¡ç®—å‡ºæ¥çš„æ‰€æœ‰ç´¢å¼•å€¼ ByIndex(indexName, indexedValue string) ([]interface{}, error) // æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡ GetIndexers() Indexers // è·å–æ‰€æœ‰çš„ Indexersï¼Œå¯¹åº” map[string]IndexFunc ç±»å‹ AddIndexers(newIndexers Indexers) error // è¿™ä¸ªæ–¹æ³•è¦åœ¨æ•°æ®åŠ å…¥å­˜å‚¨å‰è°ƒç”¨ï¼Œæ·»åŠ æ›´å¤šçš„ç´¢å¼•æ–¹æ³•ï¼Œé»˜è®¤åªé€šè¿‡ namespace æ£€ç´¢ } type Store interface { Add(obj interface{}) error Update(obj interface{}) error Delete(obj interface{}) error List() []interface{} ListKeys() []string Get(obj interface{}) (item interface{}, exists bool, err error) GetByKey(key string) (item interface{}, exists bool, err error) Replace([]interface{}, string) error Resync() error } // é»˜è®¤å®ç°ç±» type cache struct { cacheStorage ThreadSafeStore keyFunc KeyFunc } keyfunc è®¡ç®— objectçš„keyï¼Œç„¶åç”¨ThreadSafeStoreå­˜å‚¨keyï¼šobject"><meta property="og:type" content="article"><meta property="og:url" content="https://homily707.github.io/posts/k8s/client-go/"><meta property="og:image" content="https://homily707.github.io/%3Cimage%20path/url%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-10T22:39:11+08:00"><meta property="article:modified_time" content="2022-06-10T22:39:11+08:00"><meta property="og:site_name" content="mysite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://homily707.github.io/%3Cimage%20path/url%3E"><meta name=twitter:title content="Client Go"><meta name=twitter:description content="work queue Queue
queue []t // å®šä¹‰å…ƒç´ çš„å¤„ç†é¡ºåºï¼Œé‡Œé¢æ‰€æœ‰å…ƒç´ éƒ½åº”è¯¥åœ¨ dirty set ä¸­æœ‰ï¼Œè€Œä¸èƒ½å‡ºç°åœ¨ processing set ä¸­ dirty set // æ ‡è®°æ‰€æœ‰éœ€è¦è¢«å¤„ç†çš„å…ƒç´  processing set // å½“å‰æ­£åœ¨è¢«å¤„ç†çš„å…ƒç´ ï¼Œå½“å¤„ç†å®Œåéœ€è¦æ£€æŸ¥è¯¥å…ƒç´ æ˜¯å¦åœ¨ dirty set ä¸­ï¼Œå¦‚æœæœ‰åˆ™æ·»åŠ åˆ° queue é‡Œ DelayingQueue å¤šäº†ä¸€ä¸ªAddAfterï¼Œæ¯æ¬¡addåŠ å…¥å †ä¸­ï¼Œæ¯æ¬¡æ‹¿å‡ºæœ€æ—©çš„
RateLimitingQueueã€‚é™é€Ÿé˜Ÿåˆ—
Delta FIFO æ¥å£queue
æ¥å£store
items map[string]Delta
Delta. äº”ç§type added updated deleted replaced sync . å¸¦ä¸€ä¸ª interface{}
Popæ–¹æ³•ï¼šä¼šé˜»å¡ã€‚ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥é‡æ–°å…¥é˜Ÿ
Indexer type Indexer interface { Store Index(indexName string, obj interface{}) ([]interface{}, error) // æ ¹æ®ç´¢å¼•åå’Œç»™å®šçš„å¯¹è±¡è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡ IndexKeys(indexName, indexedValue string) ([]string, error) // æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡çš„ key ListIndexFuncValues(indexName string) []string // åˆ—å‡ºç´¢å¼•å‡½æ•°è®¡ç®—å‡ºæ¥çš„æ‰€æœ‰ç´¢å¼•å€¼ ByIndex(indexName, indexedValue string) ([]interface{}, error) // æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡ GetIndexers() Indexers // è·å–æ‰€æœ‰çš„ Indexersï¼Œå¯¹åº” map[string]IndexFunc ç±»å‹ AddIndexers(newIndexers Indexers) error // è¿™ä¸ªæ–¹æ³•è¦åœ¨æ•°æ®åŠ å…¥å­˜å‚¨å‰è°ƒç”¨ï¼Œæ·»åŠ æ›´å¤šçš„ç´¢å¼•æ–¹æ³•ï¼Œé»˜è®¤åªé€šè¿‡ namespace æ£€ç´¢ } type Store interface { Add(obj interface{}) error Update(obj interface{}) error Delete(obj interface{}) error List() []interface{} ListKeys() []string Get(obj interface{}) (item interface{}, exists bool, err error) GetByKey(key string) (item interface{}, exists bool, err error) Replace([]interface{}, string) error Resync() error } // é»˜è®¤å®ç°ç±» type cache struct { cacheStorage ThreadSafeStore keyFunc KeyFunc } keyfunc è®¡ç®— objectçš„keyï¼Œç„¶åç”¨ThreadSafeStoreå­˜å‚¨keyï¼šobject"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://homily707.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Client Go","item":"https://homily707.github.io/posts/k8s/client-go/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Client Go","name":"Client Go","description":"work queue Queue\nqueue []t // å®šä¹‰å…ƒç´ çš„å¤„ç†é¡ºåºï¼Œé‡Œé¢æ‰€æœ‰å…ƒç´ éƒ½åº”è¯¥åœ¨ dirty set ä¸­æœ‰ï¼Œè€Œä¸èƒ½å‡ºç°åœ¨ processing set ä¸­ dirty set // æ ‡è®°æ‰€æœ‰éœ€è¦è¢«å¤„ç†çš„å…ƒç´  processing set // å½“å‰æ­£åœ¨è¢«å¤„ç†çš„å…ƒç´ ï¼Œå½“å¤„ç†å®Œåéœ€è¦æ£€æŸ¥è¯¥å…ƒç´ æ˜¯å¦åœ¨ dirty set ä¸­ï¼Œå¦‚æœæœ‰åˆ™æ·»åŠ åˆ° queue é‡Œ DelayingQueue å¤šäº†ä¸€ä¸ªAddAfterï¼Œæ¯æ¬¡addåŠ å…¥å †ä¸­ï¼Œæ¯æ¬¡æ‹¿å‡ºæœ€æ—©çš„\nRateLimitingQueueã€‚é™é€Ÿé˜Ÿåˆ—\nDelta FIFO æ¥å£queue\næ¥å£store\nitems map[string]Delta\nDelta. äº”ç§type added updated deleted replaced sync . å¸¦ä¸€ä¸ª interface{}\nPopæ–¹æ³•ï¼šä¼šé˜»å¡ã€‚ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥é‡æ–°å…¥é˜Ÿ\nIndexer type Indexer interface { Store Index(indexName string, obj interface{}) ([]interface{}, error) // æ ¹æ®ç´¢å¼•åå’Œç»™å®šçš„å¯¹è±¡è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡ IndexKeys(indexName, indexedValue string) ([]string, error) // æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡çš„ key ListIndexFuncValues(indexName string) []string // åˆ—å‡ºç´¢å¼•å‡½æ•°è®¡ç®—å‡ºæ¥çš„æ‰€æœ‰ç´¢å¼•å€¼ ByIndex(indexName, indexedValue string) ([]interface{}, error) // æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡ GetIndexers() Indexers // è·å–æ‰€æœ‰çš„ Indexersï¼Œå¯¹åº” map[string]IndexFunc ç±»å‹ AddIndexers(newIndexers Indexers) error // è¿™ä¸ªæ–¹æ³•è¦åœ¨æ•°æ®åŠ å…¥å­˜å‚¨å‰è°ƒç”¨ï¼Œæ·»åŠ æ›´å¤šçš„ç´¢å¼•æ–¹æ³•ï¼Œé»˜è®¤åªé€šè¿‡ namespace æ£€ç´¢ } type Store interface { Add(obj interface{}) error Update(obj interface{}) error Delete(obj interface{}) error List() []interface{} ListKeys() []string Get(obj interface{}) (item interface{}, exists bool, err error) GetByKey(key string) (item interface{}, exists bool, err error) Replace([]interface{}, string) error Resync() error } // é»˜è®¤å®ç°ç±» type cache struct { cacheStorage ThreadSafeStore keyFunc KeyFunc } keyfunc è®¡ç®— objectçš„keyï¼Œç„¶åç”¨ThreadSafeStoreå­˜å‚¨keyï¼šobject","keywords":["go","k8s"],"articleBody":" work queue Queue\nqueue []t // å®šä¹‰å…ƒç´ çš„å¤„ç†é¡ºåºï¼Œé‡Œé¢æ‰€æœ‰å…ƒç´ éƒ½åº”è¯¥åœ¨ dirty set ä¸­æœ‰ï¼Œè€Œä¸èƒ½å‡ºç°åœ¨ processing set ä¸­ dirty set // æ ‡è®°æ‰€æœ‰éœ€è¦è¢«å¤„ç†çš„å…ƒç´  processing set // å½“å‰æ­£åœ¨è¢«å¤„ç†çš„å…ƒç´ ï¼Œå½“å¤„ç†å®Œåéœ€è¦æ£€æŸ¥è¯¥å…ƒç´ æ˜¯å¦åœ¨ dirty set ä¸­ï¼Œå¦‚æœæœ‰åˆ™æ·»åŠ åˆ° queue é‡Œ DelayingQueue å¤šäº†ä¸€ä¸ªAddAfterï¼Œæ¯æ¬¡addåŠ å…¥å †ä¸­ï¼Œæ¯æ¬¡æ‹¿å‡ºæœ€æ—©çš„\nRateLimitingQueueã€‚é™é€Ÿé˜Ÿåˆ—\nDelta FIFO æ¥å£queue\næ¥å£store\nitems map[string]Delta\nDelta. äº”ç§type added updated deleted replaced sync . å¸¦ä¸€ä¸ª interface{}\nPopæ–¹æ³•ï¼šä¼šé˜»å¡ã€‚ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥é‡æ–°å…¥é˜Ÿ\nIndexer type Indexer interface { Store Index(indexName string, obj interface{}) ([]interface{}, error) // æ ¹æ®ç´¢å¼•åå’Œç»™å®šçš„å¯¹è±¡è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡ IndexKeys(indexName, indexedValue string) ([]string, error) // æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡çš„ key ListIndexFuncValues(indexName string) []string // åˆ—å‡ºç´¢å¼•å‡½æ•°è®¡ç®—å‡ºæ¥çš„æ‰€æœ‰ç´¢å¼•å€¼ ByIndex(indexName, indexedValue string) ([]interface{}, error) // æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡ GetIndexers() Indexers // è·å–æ‰€æœ‰çš„ Indexersï¼Œå¯¹åº” map[string]IndexFunc ç±»å‹ AddIndexers(newIndexers Indexers) error // è¿™ä¸ªæ–¹æ³•è¦åœ¨æ•°æ®åŠ å…¥å­˜å‚¨å‰è°ƒç”¨ï¼Œæ·»åŠ æ›´å¤šçš„ç´¢å¼•æ–¹æ³•ï¼Œé»˜è®¤åªé€šè¿‡ namespace æ£€ç´¢ } type Store interface { Add(obj interface{}) error Update(obj interface{}) error Delete(obj interface{}) error List() []interface{} ListKeys() []string Get(obj interface{}) (item interface{}, exists bool, err error) GetByKey(key string) (item interface{}, exists bool, err error) Replace([]interface{}, string) error Resync() error } // é»˜è®¤å®ç°ç±» type cache struct { cacheStorage ThreadSafeStore keyFunc KeyFunc } keyfunc è®¡ç®— objectçš„keyï¼Œç„¶åç”¨ThreadSafeStoreå­˜å‚¨keyï¼šobject\nstoreçš„å®ç° type threadSafeMap struct { lock sync.RWMutex items map[string]interface{} // indexers maps a name to an IndexFunc indexers Indexers // indices maps a name to an Index indices Indices } type Index map[string]sets.String type Indexers map[string]IndexFunc type Indices map[string]Index type IndexFunc func(obj interface{}) ([]string, error) ä¸¾ä¾‹ï¼š\nfunc testUsersIndexFunc(obj interface{}) ([]string, error) { pod := obj.(*v1.Pod) usersString := pod.Annotations[\"users\"] return strings.Split(usersString, \",\"), nil } func TestMultiIndexKeys(t *testing.T) { index := NewIndexer(MetaNamespaceKeyFunc, Indexers{\"byUser\": testUsersIndexFunc}) pod1 := \u0026v1.Pod{ObjectMeta: metav1.ObjectMeta{Name: \"one\", Annotations: map[string]string{\"users\": \"ernie,bert\"}}} pod2 := \u0026v1.Pod{ObjectMeta: metav1.ObjectMeta{Name: \"two\", Annotations: map[string]string{\"users\": \"bert,oscar\"}}} pod3 := \u0026v1.Pod{ObjectMeta: metav1.ObjectMeta{Name: \"tre\", Annotations: map[string]string{\"users\": \"ernie,elmo\"}}} } item å­˜å‚¨çš„å°±æ˜¯3ä¸ªpodï¼Œ indexer å­˜å‚¨äº†ä¸€ä¸ªfuncï¼Œè¿™ä¸ªfuncä¼šå°†podçš„users splitæˆå¤šä¸ªå¹¶è¿”å› indices å­˜å‚¨äº†ä¸€ä¸ª indexï¼Œå…¶ä¸­ernie å¯¹åº”äº†2ä¸ªkeyï¼Œè¿™ä¸ªkeyç”¨äºitemæŸ¥è¯¢\nçœ‹åˆ°è¿™é‡Œå°±ä¼šæç„¶å¤§æ‚Ÿï¼Œè¿™å…¶å®å°±æ˜¯ä¸€ä¸ªå€’æ’ç´¢å¼•ã€‚å½“funcå¤šäº†ä»¥åï¼Œå°±èƒ½å®ç°éå¸¸å¼ºæ‚çš„åŠŸèƒ½äº†ã€‚\nListWatcher ç»å…¸çš„ æ¥å£ç»„åˆ\nlist å’Œ watch ç›´æ¥è°ƒç”¨ restClient è¿™é‡Œé¢å¤–éœ€è¦ä¸€ä¸ªGetter æ¥è¿”å› rest requestã€‚ ç„¶åä½¿ç”¨é—­åŒ…å‡½æ•°çš„å½¢å¼ï¼ŒæŠŠgetterä¼ ç»™restClient getterçš„å®ç°ç±» åœ¨ rest/client.go ä¸­ï¼Œç»å…¸çš„builderæ¨¡å¼\ntype Lister interface { List(options metav1.ListOptions) (runtime.Object, error) } type Watcher interface { Watch(options metav1.ListOptions) (watch.Interface, error) } // ListerWatcher is any object that knows how to perform an initial list and start a watch on a resource. type ListerWatcher interface { Lister Watcher } type Getter interface { Get() *restclient.Request } func NewListWatchFromClient(c Getter, resource string, namespace string, fieldSelector fields.Selector) *ListWatch { optionsModifier := func(options *metav1.ListOptions) { options.FieldSelector = fieldSelector.String() } return NewFilteredListWatchFromClient(c, resource, namespace, optionsModifier) } Reflector å¥å£®æ€§ä¿è¯\nlist ï¼Œä¼ ä¸€ä¸ªsync åˆ° DeltaFIFO\nwatchï¼ŒwatchHandler å¤„ç†å ä¼ å…¥ DeltaFIFO\ninformer type Controller interface { // Run does two things. One is to construct and run a Reflector // to pump objects/notifications from the Config's ListerWatcher // to the Config's Queue and possibly invoke the occasional Resync // on that Queue. The other is to repeatedly Pop from the Queue // and process with the Config's ProcessFunc. Both of these // continue until `stopCh` is closed. Run(stopCh \u003c-chan struct{}) HasSynced() bool LastSyncResourceVersion() string } type controller struct { config Config reflector *Reflector reflectorMutex sync.RWMutex clock clock.Clock } type Config struct { // The queue for your objects - has to be a DeltaFIFO due to // assumptions in the implementation. Your Process() function // should accept the output of this Queue's Pop() method. Queue // Something that can list and watch your objects. ListerWatcher // Something that can process a popped Deltas. Process ProcessFunc ObjectType runtime.Object FullResyncPeriod time.Duration RetryOnError bool WatchErrorHandler WatchErrorHandler WatchListPageSize int64 } type ResourceEventHandler interface { OnAdd(obj interface{}) OnUpdate(oldObj, newObj interface{}) OnDelete(obj interface{}) } çœŸæ­£çš„å¤„ç†é€»è¾‘ å°±æ˜¯ configé‡Œçš„Process\nSharedIndexInformer type sharedIndexInformer struct { indexer Indexer controller Controller processor *sharedProcessor cacheMutationDetector MutationDetector listerWatcher ListerWatcher // è¡¨ç¤ºå½“å‰ Informer æœŸæœ›å…³æ³¨çš„ç±»å‹ï¼Œä¸»è¦æ˜¯ GVK ä¿¡æ¯ objectType runtime.Object // reflector çš„ resync è®¡æ—¶å™¨è®¡æ—¶é—´éš”ï¼Œé€šçŸ¥æ‰€æœ‰çš„ listener æ‰§è¡Œ resync resyncCheckPeriod time.Duration defaultEventHandlerResyncPeriod time.Duration clock clock.Clock started, stopped bool startedLock sync.Mutex blockDeltas sync.Mutex watchErrorHandler WatchErrorHandler } type sharedProcessor struct { listenersStarted bool listenersLock sync.RWMutex listeners []*processorListener syncingListeners []*processorListener clock clock.Clock wg wait.Group } type processorListener struct { nextCh chan interface{} addCh chan interface{} // æ ¸å¿ƒå±æ€§ handler ResourceEventHandler pendingNotifications buffer.RingGrowing requestedResyncPeriod time.Duration resyncPeriod time.Duration nextResync time.Time resyncLock sync.Mutex } æ ¸å¿ƒå°±æ˜¯å¯¹deltaçš„å¤„ç†\nfunc (s *sharedIndexInformer) HandleDeltas(obj interface{}) error { s.blockDeltas.Lock() defer s.blockDeltas.Unlock() if deltas, ok := obj.(Deltas); ok { // æŠŠè‡ªå·±ä½œä¸º event handler ä¼ è¿›å» return processDeltas(s, s.indexer, s.transform, deltas) } return errors.New(\"object given as Process argument is not Deltas\") } func processDeltas( // Object which receives event notifications from the given deltas handler ResourceEventHandler, clientState Store, transformer TransformFunc, deltas Deltas, ) ","wordCount":"679","inLanguage":"en","image":"https://homily707.github.io/%3Cimage%20path/url%3E","datePublished":"2022-06-10T22:39:11+08:00","dateModified":"2022-06-10T22:39:11+08:00","author":{"@type":"Person","name":"homily"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://homily707.github.io/posts/k8s/client-go/"},"publisher":{"@type":"Organization","name":"æ–¯æ˜¯é™‹å®¤","logo":{"@type":"ImageObject","url":"https://homily707.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://homily707.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://homily707.github.io/tags/algo/ title=ç®—æ³•><span>ç®—æ³•</span></a></li><li><a href=https://homily707.github.io/tags/data/ title=æ•°æ®åº“><span>æ•°æ®åº“</span></a></li><li><a href=https://homily707.github.io/tags/k8s/ title=k8s><span>k8s</span></a></li><li><a href=https://homily707.github.io/tags/go/ title=go><span>go</span></a></li><li><a href=https://homily707.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://homily707.github.io/search title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://homily707.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://homily707.github.io/posts/>Posts</a></div><h1 class=post-title>Client Go</h1><div class=post-meta><span title='2022-06-10 22:39:11 +0800 CST'>June 10, 2022</span>&nbsp;Â·&nbsp;4 min&nbsp;Â·&nbsp;679 words&nbsp;Â·&nbsp;homily&nbsp;|&nbsp;<a href=https://github.com/homily707/homily707.github.io/issues rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#work-queue>work queue</a></li><li><a href=#delta-fifo>Delta FIFO</a></li><li><a href=#indexer>Indexer</a><ul><li><a href=#storeçš„å®ç°>storeçš„å®ç°</a></li></ul></li><li><a href=#listwatcher>ListWatcher</a></li><li><a href=#reflector>Reflector</a></li><li><a href=#informer>informer</a><ul><li><a href=#sharedindexinformer><strong>SharedIndexInformer</strong></a></li></ul></li></ul></nav></div></details></div><div class=post-content><p><img loading=lazy src=https://secure2.wostatic.cn/static/d7KMR8ZuATRzDhQW48ziha/image.png alt></p><h2 id=work-queue>work queue<a hidden class=anchor aria-hidden=true href=#work-queue>#</a></h2><p>Queue</p><ul><li>queue []t // å®šä¹‰å…ƒç´ çš„å¤„ç†é¡ºåºï¼Œé‡Œé¢æ‰€æœ‰å…ƒç´ éƒ½åº”è¯¥åœ¨ dirty set ä¸­æœ‰ï¼Œè€Œä¸èƒ½å‡ºç°åœ¨ processing set ä¸­</li><li>dirty set // æ ‡è®°æ‰€æœ‰éœ€è¦è¢«å¤„ç†çš„å…ƒç´ </li><li>processing set // å½“å‰æ­£åœ¨è¢«å¤„ç†çš„å…ƒç´ ï¼Œå½“å¤„ç†å®Œåéœ€è¦æ£€æŸ¥è¯¥å…ƒç´ æ˜¯å¦åœ¨ dirty set ä¸­ï¼Œå¦‚æœæœ‰åˆ™æ·»åŠ åˆ° queue é‡Œ</li></ul><p>DelayingQueue
å¤šäº†ä¸€ä¸ªAddAfterï¼Œæ¯æ¬¡addåŠ å…¥å †ä¸­ï¼Œæ¯æ¬¡æ‹¿å‡ºæœ€æ—©çš„</p><p>RateLimitingQueueã€‚é™é€Ÿé˜Ÿåˆ—</p><h2 id=delta-fifo>Delta FIFO<a hidden class=anchor aria-hidden=true href=#delta-fifo>#</a></h2><p>æ¥å£queue</p><p>æ¥å£store</p><p>items map[string]Delta</p><p>Delta. äº”ç§type added updated deleted replaced sync . å¸¦ä¸€ä¸ª interface{}</p><p>Popæ–¹æ³•ï¼šä¼šé˜»å¡ã€‚ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥é‡æ–°å…¥é˜Ÿ</p><h2 id=indexer>Indexer<a hidden class=anchor aria-hidden=true href=#indexer>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Indexer</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>Store</span>
</span></span><span class=line><span class=cl>   <span class=nf>Index</span><span class=p>(</span><span class=nx>indexName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>([]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=c1>// æ ¹æ®ç´¢å¼•åå’Œç»™å®šçš„å¯¹è±¡è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nf>IndexKeys</span><span class=p>(</span><span class=nx>indexName</span><span class=p>,</span> <span class=nx>indexedValue</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>     <span class=c1>// æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡çš„ key
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nf>ListIndexFuncValues</span><span class=p>(</span><span class=nx>indexName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>[]</span><span class=kt>string</span>                  <span class=c1>// åˆ—å‡ºç´¢å¼•å‡½æ•°è®¡ç®—å‡ºæ¥çš„æ‰€æœ‰ç´¢å¼•å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nf>ByIndex</span><span class=p>(</span><span class=nx>indexName</span><span class=p>,</span> <span class=nx>indexedValue</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span>  <span class=c1>// æ ¹æ®ç´¢å¼•åå’Œç´¢å¼•å€¼è¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nf>GetIndexers</span><span class=p>()</span> <span class=nx>Indexers</span>                     <span class=c1>// è·å–æ‰€æœ‰çš„ Indexersï¼Œå¯¹åº” map[string]IndexFunc ç±»å‹
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nf>AddIndexers</span><span class=p>(</span><span class=nx>newIndexers</span> <span class=nx>Indexers</span><span class=p>)</span> <span class=kt>error</span>    <span class=c1>// è¿™ä¸ªæ–¹æ³•è¦åœ¨æ•°æ®åŠ å…¥å­˜å‚¨å‰è°ƒç”¨ï¼Œæ·»åŠ æ›´å¤šçš„ç´¢å¼•æ–¹æ³•ï¼Œé»˜è®¤åªé€šè¿‡ namespace æ£€ç´¢
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Store</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>Add</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>  <span class=nf>Update</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>  <span class=nf>Delete</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>  <span class=nf>List</span><span class=p>()</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nf>ListKeys</span><span class=p>()</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nf>Get</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>exists</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nf>GetByKey</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>exists</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nf>Replace</span><span class=p>([]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>  <span class=nf>Resync</span><span class=p>()</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// é»˜è®¤å®ç°ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>cache</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>cacheStorage</span> <span class=nx>ThreadSafeStore</span>
</span></span><span class=line><span class=cl>   <span class=nx>keyFunc</span> <span class=nx>KeyFunc</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>keyfunc è®¡ç®— objectçš„keyï¼Œç„¶åç”¨ThreadSafeStoreå­˜å‚¨keyï¼šobject</p><h3 id=storeçš„å®ç°>storeçš„å®ç°<a hidden class=anchor aria-hidden=true href=#storeçš„å®ç°>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>threadSafeMap</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>lock</span>  <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>   <span class=nx>items</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// indexers maps a name to an IndexFunc
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>indexers</span> <span class=nx>Indexers</span>
</span></span><span class=line><span class=cl>   <span class=c1>// indices maps a name to an Index
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>indices</span> <span class=nx>Indices</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Index</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>sets</span><span class=p>.</span><span class=nx>String</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Indexers</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>IndexFunc</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Indices</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>Index</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>IndexFunc</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></div><p>ä¸¾ä¾‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>testUsersIndexFunc</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>pod</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>usersString</span> <span class=o>:=</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Annotations</span><span class=p>[</span><span class=s>&#34;users&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>usersString</span><span class=p>,</span> <span class=s>&#34;,&#34;</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestMultiIndexKeys</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>index</span> <span class=o>:=</span> <span class=nf>NewIndexer</span><span class=p>(</span><span class=nx>MetaNamespaceKeyFunc</span><span class=p>,</span> <span class=nx>Indexers</span><span class=p>{</span><span class=s>&#34;byUser&#34;</span><span class=p>:</span> <span class=nx>testUsersIndexFunc</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>pod1</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{</span><span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;one&#34;</span><span class=p>,</span> <span class=nx>Annotations</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;users&#34;</span><span class=p>:</span> <span class=s>&#34;ernie,bert&#34;</span><span class=p>}}}</span>
</span></span><span class=line><span class=cl>  <span class=nx>pod2</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{</span><span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;two&#34;</span><span class=p>,</span> <span class=nx>Annotations</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;users&#34;</span><span class=p>:</span> <span class=s>&#34;bert,oscar&#34;</span><span class=p>}}}</span>
</span></span><span class=line><span class=cl>  <span class=nx>pod3</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{</span><span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;tre&#34;</span><span class=p>,</span> <span class=nx>Annotations</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;users&#34;</span><span class=p>:</span> <span class=s>&#34;ernie,elmo&#34;</span><span class=p>}}}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>item å­˜å‚¨çš„å°±æ˜¯3ä¸ªpodï¼Œ
indexer å­˜å‚¨äº†ä¸€ä¸ªfuncï¼Œè¿™ä¸ªfuncä¼šå°†podçš„users splitæˆå¤šä¸ªå¹¶è¿”å›
indices å­˜å‚¨äº†ä¸€ä¸ª indexï¼Œå…¶ä¸­ernie å¯¹åº”äº†2ä¸ªkeyï¼Œè¿™ä¸ªkeyç”¨äºitemæŸ¥è¯¢</p><p><img loading=lazy src=https://secure2.wostatic.cn/static/3U2iyuejLkobvwUoZ58XQf/image.png alt></p><p><img loading=lazy src=https://secure2.wostatic.cn/static/ii5SYxWqrLP9or7GxBCzJS/image.png alt></p><p><img loading=lazy src=https://secure2.wostatic.cn/static/2oXqsf48KitnB1GgCMVqJG/image.png alt></p><p>çœ‹åˆ°è¿™é‡Œå°±ä¼šæç„¶å¤§æ‚Ÿï¼Œè¿™å…¶å®å°±æ˜¯ä¸€ä¸ªå€’æ’ç´¢å¼•ã€‚å½“funcå¤šäº†ä»¥åï¼Œå°±èƒ½å®ç°éå¸¸å¼ºæ‚çš„åŠŸèƒ½äº†ã€‚</p><h2 id=listwatcher>ListWatcher<a hidden class=anchor aria-hidden=true href=#listwatcher>#</a></h2><p>ç»å…¸çš„ æ¥å£ç»„åˆ</p><p>list å’Œ watch ç›´æ¥è°ƒç”¨ restClient
è¿™é‡Œé¢å¤–éœ€è¦ä¸€ä¸ªGetter æ¥è¿”å› rest requestã€‚
ç„¶åä½¿ç”¨é—­åŒ…å‡½æ•°çš„å½¢å¼ï¼ŒæŠŠgetterä¼ ç»™restClient
getterçš„å®ç°ç±» åœ¨ rest/client.go ä¸­ï¼Œç»å…¸çš„builderæ¨¡å¼</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Lister</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>List</span><span class=p>(</span><span class=nx>options</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>)</span> <span class=p>(</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Watcher</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>Watch</span><span class=p>(</span><span class=nx>options</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>)</span> <span class=p>(</span><span class=nx>watch</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ListerWatcher is any object that knows how to perform an initial list and start a watch on a resource.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ListerWatcher</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Lister</span>
</span></span><span class=line><span class=cl>  <span class=nx>Watcher</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Getter</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>Get</span><span class=p>()</span> <span class=o>*</span><span class=nx>restclient</span><span class=p>.</span><span class=nx>Request</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewListWatchFromClient</span><span class=p>(</span><span class=nx>c</span> <span class=nx>Getter</span><span class=p>,</span> <span class=nx>resource</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>namespace</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>fieldSelector</span> <span class=nx>fields</span><span class=p>.</span><span class=nx>Selector</span><span class=p>)</span> <span class=o>*</span><span class=nx>ListWatch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>optionsModifier</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>options</span> <span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=p>.</span><span class=nx>FieldSelector</span> <span class=p>=</span> <span class=nx>fieldSelector</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>NewFilteredListWatchFromClient</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>,</span> <span class=nx>optionsModifier</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=reflector>Reflector<a hidden class=anchor aria-hidden=true href=#reflector>#</a></h2><p>å¥å£®æ€§ä¿è¯</p><p>list ï¼Œä¼ ä¸€ä¸ªsync åˆ° DeltaFIFO</p><p>watchï¼ŒwatchHandler å¤„ç†å ä¼ å…¥ DeltaFIFO</p><h2 id=informer>informer<a hidden class=anchor aria-hidden=true href=#informer>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Controller</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Run does two things.  One is to construct and run a Reflector
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// to pump objects/notifications from the Config&#39;s ListerWatcher
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// to the Config&#39;s Queue and possibly invoke the occasional Resync
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// on that Queue.  The other is to repeatedly Pop from the Queue
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// and process with the Config&#39;s ProcessFunc.  Both of these
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// continue until `stopCh` is closed.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>  <span class=nf>HasSynced</span><span class=p>()</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>  <span class=nf>LastSyncResourceVersion</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>controller</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>config</span>         <span class=nx>Config</span>
</span></span><span class=line><span class=cl>  <span class=nx>reflector</span>      <span class=o>*</span><span class=nx>Reflector</span>
</span></span><span class=line><span class=cl>  <span class=nx>reflectorMutex</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>  <span class=nx>clock</span>          <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// The queue for your objects - has to be a DeltaFIFO due to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// assumptions in the implementation. Your Process() function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// should accept the output of this Queue&#39;s Pop() method.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Queue</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Something that can list and watch your objects.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>ListerWatcher</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Something that can process a popped Deltas.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Process</span> <span class=nx>ProcessFunc</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>ObjectType</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span>
</span></span><span class=line><span class=cl>  <span class=nx>FullResyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>  <span class=nx>RetryOnError</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>  <span class=nx>WatchErrorHandler</span> <span class=nx>WatchErrorHandler</span>
</span></span><span class=line><span class=cl>  <span class=nx>WatchListPageSize</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ResourceEventHandler</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>OnAdd</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>  <span class=nf>OnUpdate</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>newObj</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>  <span class=nf>OnDelete</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>çœŸæ­£çš„å¤„ç†é€»è¾‘ å°±æ˜¯ configé‡Œçš„Process</p><h3 id=sharedindexinformer><strong>SharedIndexInformer</strong><a hidden class=anchor aria-hidden=true href=#sharedindexinformer>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>sharedIndexInformer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>indexer</span>    <span class=nx>Indexer</span>
</span></span><span class=line><span class=cl>   <span class=nx>controller</span> <span class=nx>Controller</span>
</span></span><span class=line><span class=cl>   <span class=nx>processor</span>             <span class=o>*</span><span class=nx>sharedProcessor</span>
</span></span><span class=line><span class=cl>   <span class=nx>cacheMutationDetector</span> <span class=nx>MutationDetector</span>
</span></span><span class=line><span class=cl>   <span class=nx>listerWatcher</span> <span class=nx>ListerWatcher</span>
</span></span><span class=line><span class=cl>   <span class=c1>// è¡¨ç¤ºå½“å‰ Informer æœŸæœ›å…³æ³¨çš„ç±»å‹ï¼Œä¸»è¦æ˜¯ GVK ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>objectType</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span>
</span></span><span class=line><span class=cl>   <span class=c1>// reflector çš„ resync è®¡æ—¶å™¨è®¡æ—¶é—´éš”ï¼Œé€šçŸ¥æ‰€æœ‰çš„ listener æ‰§è¡Œ resync
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>resyncCheckPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>   <span class=nx>defaultEventHandlerResyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>   <span class=nx>clock</span> <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
</span></span><span class=line><span class=cl>   <span class=nx>started</span><span class=p>,</span> <span class=nx>stopped</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>   <span class=nx>startedLock</span>      <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>   <span class=nx>blockDeltas</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>   <span class=nx>watchErrorHandler</span> <span class=nx>WatchErrorHandler</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>sharedProcessor</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>listenersStarted</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>   <span class=nx>listenersLock</span>    <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>   <span class=nx>listeners</span>        <span class=p>[]</span><span class=o>*</span><span class=nx>processorListener</span>
</span></span><span class=line><span class=cl>   <span class=nx>syncingListeners</span> <span class=p>[]</span><span class=o>*</span><span class=nx>processorListener</span>
</span></span><span class=line><span class=cl>   <span class=nx>clock</span>            <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
</span></span><span class=line><span class=cl>   <span class=nx>wg</span>               <span class=nx>wait</span><span class=p>.</span><span class=nx>Group</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>processorListener</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>nextCh</span> <span class=kd>chan</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>   <span class=nx>addCh</span>  <span class=kd>chan</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// æ ¸å¿ƒå±æ€§
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>handler</span> <span class=nx>ResourceEventHandler</span>
</span></span><span class=line><span class=cl>   <span class=nx>pendingNotifications</span> <span class=nx>buffer</span><span class=p>.</span><span class=nx>RingGrowing</span>
</span></span><span class=line><span class=cl>   <span class=nx>requestedResyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>   <span class=nx>resyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>   <span class=nx>nextResync</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>   <span class=nx>resyncLock</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>æ ¸å¿ƒå°±æ˜¯å¯¹deltaçš„å¤„ç†</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>sharedIndexInformer</span><span class=p>)</span> <span class=nf>HandleDeltas</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>blockDeltas</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>blockDeltas</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>deltas</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=nx>Deltas</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æŠŠè‡ªå·±ä½œä¸º event handler ä¼ è¿›å»
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nf>processDeltas</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>indexer</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>transform</span><span class=p>,</span> <span class=nx>deltas</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;object given as Process argument is not Deltas&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>processDeltas</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Object which receives event notifications from the given deltas
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>handler</span> <span class=nx>ResourceEventHandler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>clientState</span> <span class=nx>Store</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>transformer</span> <span class=nx>TransformFunc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>deltas</span> <span class=nx>Deltas</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> 
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://homily707.github.io/tags/go/>go</a></li><li><a href=https://homily707.github.io/tags/k8s/>k8s</a></li></ul><nav class=paginav><a class=next href=https://homily707.github.io/posts/db/6.824-lab2-coding/><span class=title>Next Â»</span><br><span>6.824 Lab2 Coding</span></a></nav></footer><script src=https://utteranc.es/client.js repo=homily707/homily707.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://homily707.github.io/>æ–¯æ˜¯é™‹å®¤</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>