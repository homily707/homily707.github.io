<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>6.824 | 斯是陋室</title><meta name=keywords content><meta name=description content="勿在浮沙筑高台"><meta name=author content="Me"><link rel=canonical href=https://homily707.github.io/tags/6.824/><link crossorigin=anonymous href=/assets/css/stylesheet.d7fb4cbf980fe688a21621b06a795933c4e6bb2d4070ec940667af1715d84af2.css integrity="sha256-1/tMv5gP5oiiFiGwanlZM8Tmuy1AcOyUBmevFxXYSvI=" rel="preload stylesheet" as=style><link rel=icon href=https://homily707.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://homily707.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://homily707.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://homily707.github.io/apple-touch-icon.png><link rel=mask-icon href=https://homily707.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://homily707.github.io/tags/6.824/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="6.824"><meta property="og:description" content="勿在浮沙筑高台"><meta property="og:type" content="website"><meta property="og:url" content="https://homily707.github.io/tags/6.824/"><meta property="og:site_name" content="mysite"><meta name=twitter:card content="summary"><meta name=twitter:title content="6.824"><meta name=twitter:description content="勿在浮沙筑高台"></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://homily707.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://homily707.github.io/tags/algo/ title=算法><span>算法</span></a></li><li><a href=https://homily707.github.io/tags/data/ title=数据库><span>数据库</span></a></li><li><a href=https://homily707.github.io/tags/k8s/ title=k8s><span>k8s</span></a></li><li><a href=https://homily707.github.io/tags/go/ title=go><span>go</span></a></li><li><a href=https://homily707.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://homily707.github.io/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://homily707.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://homily707.github.io/tags/>Tags</a></div><h1>6.824
<a href=index.xml title=RSS aria-label=RSS><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="23"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></h1></header><article class="post-entry tag-entry"><header class=entry-header><h2>6.824 Lab2 Coding</h2></header><div class=entry-content><p>flow
livelocks 系统没有阻塞。但是状态来回转换，没有进展。比如多节点同时竞选。
当收到心跳、自己参与竞选、收到竞选申请时，三种情况下，都要重置election timeout 计时
Incorrect RPC handler 如果reply false，快速结束，不要执行其余子过程 entries为null的rpc也要处理 日志处理的rule5是必要的 Failure to follow rule 确保apply只进行了一次 周期检查commit和apply或者每次commit时apply 如果append 由于term不一致被拒绝，不要更新nextIndex 不能更新以前term的commit Term confusion 当获得来自以前term的reply。如果term不同，不处理 2A：leader election 官方hints
RequestVote 参加竞选 handler 参与投票。5秒内选出新leader AppendEntries 心跳。 每秒不超过十次 犯的几个错：
忘了维护votedFor的值 心跳的间隔时间要确保小于随机check时间 旧主以及竞选失败者 收到心跳时，没有退化 旧主disconnects，进入election，但是没有竞选 leader 也给自己发了心跳 收到竞选，停止心跳检查，停止参加竞选 计票统计，没有并发控制 参与竞选，要并发执行 几个实现：
log 标准化，每次打印当前 raft的状态的，并用emoji来区分 log.SetFlags(log.Lmicroseconds) 可变参数的引用和解引用 func (rf Raft) Log(format string, args ...interface{}) { RaftPrintf(format, args...) } 2B：log 官方hints
实现 election restriction 可能会出现多主的bug，请查看timer的实现或者不要立刻发心跳 通过condition 或者 sleep，不要让检查状态的进程死循环 犯的错...</p></div><footer class=entry-footer><span title='2022-05-02 13:09:12 +0800 CST'>May 2, 2022</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;78 words&nbsp;·&nbsp;homily</footer><a class=entry-link aria-label="post link to 6.824 Lab2 Coding" href=https://homily707.github.io/posts/db/6.824-lab2-coding/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>6.824 Lab2 Paper</h2></header><div class=entry-content><p>replicated state machines 多个状态机保持相同的状态
实现，通过日志，按顺序保存command。先复制，再执行
非拜占庭问题下正常工作 多数节点可用时整体可用 paxos 缺点 难以理解、不好实现
设计 分解、减少状态
algorithm basics 最少5个节点 三种节点 leader、follower、candidate 每一次选举都是一次term，选举失败也算一次。 每个节点存储当前 term，并在每次交流中带上，如果自己过时了（乃不知有汉，无论魏晋），则跟上最新的。leader和candidater 如果发现过时，退为follower RPC 有两种vote、 append 、 （retry） 选主 心跳 开始都是follower。leader会定期发送心跳（没有log的 appendRpc）
election timeout，follower长期没收到心跳，开始竞选。增加 term，切为 candidate，开始循环给所有人发送 voteRpc。会有3种结果 自己选上、别人选上、超时
选举，每个节点投票给第一个找自己竞选的，参选者投自己。
收到超过半数的投票，自己上任，给别人发心跳。如果收到竞选term的leader指令，代表自己失败。
如果超时，增加term，重新竞选。
防止多人参选，随机election timeout。candidate需要每次选举前，更新随机timeout
日志复制 先群发 appendRpc。超过半数确认，然后commit。append中下发commited index 超时无响应，重发
日志信息保存term
append 带上 上一次的entry，follower没找到这个的话，说明有漏，就不接受 主节点被拒绝后，会减小index
当主节点出错时，新任leader强制以自己的log为准 主节点保存所有从的 nextIndex
Safety 之前两节并不能保证各节点 exec same command in same order。比如一个落后很多的节点，timeout后竞选成为主节点然后执行后续命令会导致其他节点出错。
这一节添加了选为主节点的限制。保证每个任期的leader都持有所有已提交的命令。 并且精细了commit的规则 最后，给出了证明
5.4.1 election restriction 有主节点的共识算法，主节点必须存储所有已提交entries。
Raft在不向主节点传递日志的情况下实现这一点。log流向只会从主节点发往其他...</p></div><footer class=entry-footer><span title='2022-05-02 13:08:10 +0800 CST'>May 2, 2022</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;79 words&nbsp;·&nbsp;homily</footer><a class=entry-link aria-label="post link to 6.824 Lab2 Paper" href=https://homily707.github.io/posts/db/6.824-lab2-paper/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>6.824 Lab2 Guide</h2></header><div class=entry-content><p>guidance Read this guide for Raft specific advice. Advice on locking in labs. Advice on structuring your Raft lab. This Diagram of Raft interactions may help you understand code flow between different parts of the system. Dprint and colorful print debuging fault因 error 果 （隐藏的error， 出现的error，masked的error） 程序的三种状态
程序正确，但是已经有 fault fault已经产生latent error。但是还未明显影响程序状态 error出现 做法
想办法，减少阶段2持续的时间，所以就能更快的定位1切换到2的时候。 保持头脑清醒，聚焦当前的first observable error，不停的往前追溯。 bisection instrumentation
要能方便地调节log的详细程度 可读性，颜色，保持一致的输出 加强新增日志能力 tips
多个faults时，先找第一个 不要轻易排除，不要依赖你脑海中的模型，always verify your assumptions 复盘 不要做 不成熟的补救 fail loudly， offensive programming 偶发bug，疯狂的输出日志，坐等复现 先想想what the fuck the test is doing</p></div><footer class=entry-footer><span title='2022-05-02 11:37:08 +0800 CST'>May 2, 2022</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;83 words&nbsp;·&nbsp;homily</footer><a class=entry-link aria-label="post link to 6.824 Lab2 Guide" href=https://homily707.github.io/posts/db/6.824-lab2-guide/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>6.824 Lab1</h2></header><div class=entry-content><p>实现 master有四个状态，不同的状态使用不同的处理逻辑。而worker是无状态的，直接干活job就行了，只用判断一下job的类型 map reduce的原理很好理解，直接实现即可 master用两个 chan 来保存当前要下发的map job 和 reduce job，用一个RWMap来管理job的状态。因为涉及并发，每次都要上锁。
错误处理 job下发时记录下下发时间，收到job完成时要和下发时间进行比较。在Done函数中，定时遍历检查job状态，有超时的重新传入chan。
库函数积累 json.NewDecoder(file)
json.NewEncoder(tempFile)
dec.Decode(&kv)
ioutil.TempFile</p></div><footer class=entry-footer><span title='2022-04-22 11:42:44 +0800 CST'>April 22, 2022</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;18 words&nbsp;·&nbsp;homily</footer><a class=entry-link aria-label="post link to 6.824 Lab1" href=https://homily707.github.io/posts/db/6.824-lab1/></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://homily707.github.io/>斯是陋室</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>